name: CI
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: true
          token: ${{ secrets.FINE_GRAINED_PAT }}

      # ==== JAVA 21 (BẮT BUỘC CHO PAPER 1.21.4) ====
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # ==== CLOUDFLARED ====
      - name: Add Cloudflare repository
        run: |
          sudo mkdir -p --mode=0755 /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared jammy main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared jq

      # ==== DOWNLOAD PAPER 1.21.4 ====
      - name: Download Paper 1.21.4
        run: |
          if [ ! -f paper.jar ]; then
            curl -L -o paper.jar https://api.papermc.io/v2/projects/paper/versions/1.21.4/builds/1/downloads/paper-1.21.4-1.jar
          fi
          echo "eula=true" > eula.txt

      # ==== RUN PAPER + CLOUDFLARE + AUTO RESTART ====
      - name: Run Paper and Cloudflared
        if: "!contains(github.event.head_commit.message, 'Auto commit every 30 seconds [no ci]')"
        continue-on-error: true
        env:
          FINE_GRAINED_PAT: ${{ secrets.FINE_GRAINED_PAT }}
          REPO: ${{ github.repository }}
          CF_TUNNEL_CERT: ${{ secrets.CF_CERT }}
          CF_TUNNEL_UUID: ${{ secrets.CF_TUNNEL_UUID_1 }}
          CF_TUNNEL_UUID_CONTENT: ${{ secrets.CF_TUNNEL_UUID_CONTENT }}
        run: |
          cd $GITHUB_WORKSPACE

          mkdir -p ~/.cloudflared
          echo "$CF_TUNNEL_CERT" > ~/.cloudflared/cert.pem
          echo "$CF_TUNNEL_UUID_CONTENT" > credentials.json

          cat <<EOF > tunnel-config.yml
          tunnel: $CF_TUNNEL_UUID
          credentials-file: credentials.json
          ingress:
            - service: tcp://localhost:25565
          EOF

          # ===== FAKE 12GB RAM (KHÔNG OOM) =====
          export JAVA_TOOL_OPTIONS="-XX:MaxRAM=6G -XX:MaxRAMPercentage=100"

          start_paper() {
            echo "Starting Paper 1.21.4..."
            java \
              -XX:+UseG1GC \
              -XX:+ParallelRefProcEnabled \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UnlockExperimentalVMOptions \
              -XX:+DisableExplicitGC \
              -XX:+AlwaysPreTouch \
              -XX:G1NewSizePercent=30 \
              -XX:G1MaxNewSizePercent=40 \
              -XX:G1HeapRegionSize=8M \
              -XX:G1ReservePercent=20 \
              -XX:G1HeapWastePercent=5 \
              -XX:G1MixedGCCountTarget=4 \
              -XX:InitiatingHeapOccupancyPercent=15 \
              -XX:G1MixedGCLiveThresholdPercent=90 \
              -XX:G1RSetUpdatingPauseTimePercent=5 \
              -XX:SurvivorRatio=32 \
              -XX:+PerfDisableSharedMem \
              -XX:MaxTenuringThreshold=1 \
              -Dusing.aikars.flags=https://mcflags.emc.gs \
              -Daikars.new.flags=true \
              -Xms12G -Xmx12G \
              -jar paper.jar nogui 2>&1 | sed '/login:/s/.*/<REDACTED>/' &
            PAPER_PID=$!
            echo "Paper PID: $PAPER_PID"
          }

          start_cloudflared() {
            cloudflared tunnel run --config tunnel-config.yml $CF_TUNNEL_UUID &
            CLOUDFLARED_PID=$!
            echo "Cloudflared PID: $CLOUDFLARED_PID"
          }

          commit_and_push() {
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add -A
            git reset -- tunnel-config.yml credentials.json logs/ || true
            git commit -m "Auto commit every 30 seconds [no ci]" || return 1
            git push https://x-access-token:${FINE_GRAINED_PAT}@github.com/${GITHUB_REPOSITORY}.git HEAD:main --force
          }

          create_new_workflow_run() {
            curl -s -X POST \
              -H "Authorization: token $FINE_GRAINED_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${REPO}/actions/workflows/CI.yml/dispatches \
              -d '{"ref":"main"}'
          }

          start_paper
          start_cloudflared

          START_TIME=$(date +%s)
          (sleep 20 && rm -f credentials.json) &

          while true; do
            commit_and_push || true

            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))

            if ! kill -0 $PAPER_PID 2>/dev/null; then
              echo "Paper crashed, restarting..."
              start_paper
            fi

            if ! kill -0 $CLOUDFLARED_PID 2>/dev/null || [ $ELAPSED -ge 18000 ]; then
              echo "Restarting workflow..."
              create_new_workflow_run
              exit 0
            fi

            sleep 30
          done
